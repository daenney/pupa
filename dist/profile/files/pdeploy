#!/usr/bin/env bash

### - Bash Strict mode - ###
set -euo pipefail
IFS=$'\n\t'
### - Bash Strict mode - ###

function timestamp {
  # Current time including UTC offset
  date +'%H:%M:%S %z'
}

function log {
  echo "$(timestamp) ${@}"
}

if test -f '/var/cache/pupa/disable-puppet'; then
  log "Puppet has been disabled since $(stat -c %y /var/cache/pupa/disable-puppet), not running" >&2
  exit 1
fi

cd /var/cache/pupa
log "git: resetting pupa checkout"
/usr/bin/git reset --hard HEAD
log "git: updating pupa checkout"
/usr/bin/git pull
if test $# -lt 1; then
  log "Need at least an environment name to apply" >&2
  exit 1
elif test $# -eq 1; then
  log "r10k: deploying environment: '${@}'"
  /usr/local/bin/r10k deploy environment ${@} -pv
  log "papply: running with arguments '${@}'"
  /usr/local/bin/papply "${@}"
else
  env="${1}"
  shift 1
  rest="${@}"
  log "r10k: deploying environment: '${env}'"
  /usr/local/bin/r10k deploy environment ${env} -pv
  log "papply: running with arguments '${env} ${rest}'"
  /usr/local/bin/papply "${env}" "${rest}"
fi
log "pdeploy: done"
exit 0
